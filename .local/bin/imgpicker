#!/usr/bin/env bash

# base code from breadonpenguins

case "$(uname -a)" in
    *Darwin*) UEBERZUG_TMP_DIR="$TMPDIR" ;;
    *) UEBERZUG_TMP_DIR="/tmp" ;;
esac

cleanup() {
    ueberzugpp cmd -s "$SOCKET" -a exit
}

trap cleanup HUP INT QUIT TERM EXIT

UB_PID_FILE="$UEBERZUG_TMP_DIR/.$(uuidgen)"
ueberzugpp layer --no-stdin --silent --use-escape-codes --pid-file "$UB_PID_FILE"
UB_PID=$(cat "$UB_PID_FILE")

export SOCKET="$UEBERZUG_TMP_DIR"/ueberzugpp-"$UB_PID".socket


case $2 in
        *m) # â‚ŠâŠ¹Éªá´É¢á´É¢á´‹âŠ¹â‚Š options
        FZFARGS="\
enter:execute(feh {}),\
ctrl-w:execute(feh --bg-fill {}),\
ctrl-g:execute(gimp {+} > /dev/null 2>&1),\
ctrl-y:execute(imgclip copy {})"
        ILABEL="  ð”¦ð•žðšâ’¼ï½… â“œð”¢ð“·â“Š  "
        LABEL="[á´„á´›Ê€ÊŸ | g: É¢Éªá´á´˜ | d: á´…á´‡ÊŸ | c: á´„á´á´˜Ê]"
    ;;
        # *c) # cliphist options
        #         ILABEL="á´„ÊŸÉªá´˜ÊœÉªsá´›: á´‡É´á´›á´‡R/á´„á´›Ê€ÊŸ-c: á´„á´á´˜Ê"
        #         LABEL="[á´„á´›Ê€ÊŸ g: á´‡á´…Éªá´› ÉªÉ´ É¢Éªá´á´˜ | d: á´…á´‡ÊŸ | t: á´›á´ á´›Ê€á´€É´sá´˜á´€Ê€á´‡É´á´›]"
        #         FZFARGS='enter:execute(imgclip copy {}),ctrl-c:execute(txtclip copy {}),ctrl-t:execute-silent(imgmgk transparencyrecopy {+}),ctrl-g:become(gimp {+} > /dev/null 2>&1),ctrl-d:execute(rm {} && notify-send {} deleted)' ;;    
        *) FZFARGS='ctrl-d:execute(rm -i {} && notify-send {} deleted)' ;; # normal options
esac

fzf --walker-root=${1:-$PWD} $3 -m --bind "$FZFARGS" --style ${STYLE:-full} --reverse --preview-border --preview-label "$LABEL" --input-label "$ILABEL" --preview="ueberzugpp cmd -s $SOCKET -i fzfpreview -a add \
                        -x \$FZF_PREVIEW_LEFT -y \$FZF_PREVIEW_TOP \
                        --max-width \$FZF_PREVIEW_COLUMNS --max-height \$FZF_PREVIEW_LINES \
                        -f {} || bat --style=plainm --color=always {}"

ueberzugpp cmd -s "$SOCKET" -a exit
